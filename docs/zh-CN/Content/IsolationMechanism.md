# 隔离机制

在 Sandboxie 监督下启动的进程会被创建时赋予一个非常受限的用户令牌，使它们基本上没有权限访问几乎任何内容。在这种状态下，它们将几乎完全无用并会立即崩溃。

这种令牌操作是使用 Windows 内核中的半打[未公开符号](TokenMagic.md)完成的。

在下一步中，Sandboxie 通过挂钩大多数 ntdll.dll 系统调用并将它们重定向到自己的 SbieDrv 驱动程序来尝试修复这种情况。然后驱动程序会评估这些调用并执行沙盒化规则，例如，不允许在沙盒外写入，也不允许读取已关闭的资源。

当恶意应用程序试图取消挂钩 ntdll.dll 时，例如，通过尝试直接向 Windows 内核发起系统调用，内核会看到受限的用户令牌，操作会因访问被拒绝而失败。

并非所有功能都可以通过这种方式恢复，因此 Sandboxie 还会挂钩标准 Windows DLL 中的大量其他函数，通过辅助服务 SbieSvc 提供变通方法和重定向，尽管有时它会选择直接禁用某些功能。

文件系统和注册表虚拟化是在用户级别的 SbieDll 中实现的，它负责将真实系统的数据与沙盒中的数据组合在一起，并正确重定向所有访问尝试。如果该机制被不当绕过，将导致访问被拒绝错误。 